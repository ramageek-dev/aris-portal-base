var dhtmlXVaultObject=function(){var a=navigator.appName;this.IE=a.indexOf("Explorer")>-1;this.Opera=a.indexOf("Opera")>-1;this.isUploadFile=false;this.isUploadFileAll=false;this.counter=1;this.idRowSelected=null;this.sessionId=null;this.pathUploadHandler=null;this.pathGetInfoHandler=null;this.pathGetIdHandler=null;this.imPath="imgs/";this.strings={remove:"Remove",upload:"Upload",done:"Done",error:"ERROR",btnAdd:"Add file",btnUpload:"Upload",btnClean:"Clean"};this.strings.errors={TooBig:"File is too big ({0};bytes).\nMax allowed size is {1}.",PostSize:"Undefined server error. Possible issues:\n- Unicode file name incorrectly processed by the server;\n- File size is bigger than server's post-request limit ({0})."};this.filesLimit=0;this.fileList={};this.uploadedCount=0;this.progressDemo=null;this.inpMAX_FILE_SIZE=null;this.MAX_FILE_SIZE=900*1024*1024;this.inpUPLOAD_IDENTIFIER=null};dhtmlXVaultObject.prototype.setServerHandlers=function(a,b,c){this.pathUploadHandler=a;this.pathGetInfoHandler=b;this.pathGetIdHandler=c};dhtmlXVaultObject.prototype.setImagePath=function(a){this.imPath=a;this.preLoadImages()};dhtmlXVaultObject.prototype.create=function(a){this.parentObject=document.getElementById(a);this.parentObject.style.position="relative";this.parentObject.innerHTML="<iframe src='about:blank' id='dhtmlxVaultUploadFrame' name='dhtmlxVaultUploadFrame' style='display:none;position:absolute;left:-1000px;width:1px;height:1px'></iframe>";this.containerDiv=document.createElement("div");this.containerDiv.className="dhxvlt_panel2border";this.containerDiv.style.cssText="position:absolute;overflow-y:auto;height:190px;background-color:#FFFFFF;top:10px;left:10px;z-index:10;width:410px";this.parentObject.appendChild(this.containerDiv);this.container=document.createElement("div");this.container.style.position="relative";this.container.innerHTML="<table class='dhxvlt_panelbg dhxvlt_panelborder' border='0'>"+"<tr><td style='width:416px' colspan='3' align='center' id='cellContainer'>"+"<div style='height:200px'></div>"+"</td></tr>"+"<tr><td style='width:100px;height:32px' align='left'></td>"+"<td style='width:180px;height:32px' align='left'>"+"<div class='dhxvlt_lbtn'><span class='dhxvlt_lbtn1'></span><span class='dhxvlt_lbtn2'><nobr><img src='"+this.imPath+"upload.gif'/> "+this.strings.btnUpload+"</nobr></span><span class='dhxvlt_lbtn3'></span></div></td>"+"<td style='width:136px;height:32px;' align='right'>"+"<div class='dhxvlt_rbtn'><span class='dhxvlt_rbtn3'></span><span class='dhxvlt_rbtn2'><nobr><img src='"+this.imPath+"clean.gif'/> "+this.strings.btnClean+"</nobr></span><span class='dhxvlt_rbtn1'></span></div></td></tr></table>"+"<div class='btnAddBtn dhxvlt_lbtn'><span class='dhxvlt_lbtn1'></span><span class='dhxvlt_lbtn2'><nobr><img src='"+this.imPath+"add.gif'/> "+this.strings.btnAdd+"</nobr></span><span class='dhxvlt_lbtn3'></span></div>"+"<div class='btnAddDiv'>"+"<input type='file' id='file1' name='file1' value='' class='dhxvlt_hidden "+(this.Opera?"dhxvlt_fo":"")+"'/></div>";this.parentObject.appendChild(this.container);var b=this;this.container.childNodes[0].rows[1].cells[1].childNodes[0].onclick=function(){b.uploadAllItems()};this.container.childNodes[0].rows[1].cells[2].childNodes[0].onclick=function(){b.removeAllItems()};this.fileContainer=this.container.childNodes[2];this.currentFile=this.fileContainer.childNodes[0];this.currentFile.onchange=function(){b.addFile()};if(this.IE){this.uploadForm=document.createElement("<form enctype='multipart/form-data' target='dhtmlxVaultUploadFrame' method='post'>")}else{this.uploadForm=document.createElement("form");this.uploadForm.method="post";this.uploadForm.encoding="multipart/form-data";this.uploadForm.target="dhtmlxVaultUploadFrame"}this.container.appendChild(this.uploadForm);this.inpMAX_FILE_SIZE=document.createElement("input");this.inpMAX_FILE_SIZE.type="hidden";this.inpMAX_FILE_SIZE.name="xMAX_FILE_SIZE";this.inpMAX_FILE_SIZE.value=this.MAX_FILE_SIZE;this.uploadForm.appendChild(this.inpMAX_FILE_SIZE);this.inpUPLOAD_IDENTIFIER=document.createElement("input");this.inpUPLOAD_IDENTIFIER.type="hidden";this.inpUPLOAD_IDENTIFIER.name="UPLOAD_IDENTIFIER";this.uploadForm.appendChild(this.inpUPLOAD_IDENTIFIER);this.tblListFiles=null;this.tblProgressBar=this.createProgressBar();this.percentPanel=this.createPercentPanel();this.containerDiv.appendChild(this.percentPanel);this.progressDemo=this.createProgressDemo()};dhtmlXVaultObject.prototype.createXMLHttpRequest=function(){var a=null;if(window.ActiveXObject){a=new ActiveXObject("Microsoft.XMLHTTP")}else if(window.XMLHttpRequest){a=new XMLHttpRequest}return a};dhtmlXVaultObject.prototype.getFileName=function(a){var b=a.split("\\");a=b[b.length-1];b=a.split("/");return b[b.length-1]};dhtmlXVaultObject.prototype.selectItem=function(a){var b=this.getCurrentRowListFiles(a);if(this.idRowSelected){var c=this.getCurrentRowListFiles(this.idRowSelected);if(c){if(c.id!=b.id){b.className="dhxvlt_rowsel";this.idRowSelected=a;c.className="dhxvlt_row"}else{b.className="dhxvlt_row";this.idRowSelected=""}}else{b.className="dhxvlt_rowsel";this.idRowSelected=a}}else{b.className="dhxvlt_rowsel";this.idRowSelected=a}};dhtmlXVaultObject.prototype.enableAddButton=function(a){this.currentFile.disabled=!a;var b=this.currentFile.parentNode.previousSibling.childNodes[1].childNodes[0].childNodes[0];b.src=this.imPath+(a?"add.gif":"add_d.gif");b.parentNode.className=a?"":"dhxvlt_dis"};dhtmlXVaultObject.prototype.checkFilesLimit=function(){if(this.filesLimit>0){var a=this.getTotalFilesCount();this.enableAddButton(a<this.filesLimit)}};dhtmlXVaultObject.prototype.addFile=function(){var a=this.currentFile;try{if(a.value=="")return;if(!this.onAddFile(a.value)){a.value="";return}}catch(b){}var c=this.createId();this.fileList[c]={id:c,name:a.value,uploaded:false,error:false};a.disabled=true;a.style.display="none";this.uploadForm.appendChild(a);var d=document.createElement("input");d.type="file";d.className="dhxvlt_hidden"+(this.Opera?" dhxvlt_fo":"");d.id="file"+(c+1);d.name=d.id;this.currentFile=d;var e=this;d.onchange=function(){return e.addFile()};this.fileContainer.appendChild(d);var f=this.getFileName(a.value);var g=this.getImgFile(f);var h=this.containerDiv;if(this.tblListFiles==null){this.tblListFiles=this.createTblListFiles();h.appendChild(this.tblListFiles)}var i=this.tblListFiles.insertRow(this.tblListFiles.rows.length);i.setAttribute("fileItemId",c);i.setAttribute("id","rowListFiles"+c);i.setAttribute("isUpload","false");i.onclick=function(){e.selectItem(c)};var j=document.createElement("td");j.align="center";i.appendChild(j);var k=document.createElement("table");j.appendChild(k);k.style.cssText="border-bottom:1px solid #E2E2E2";k.cellPadding="0px";k.cellSpacing="0px";k.border="0px";k.id="tblContent"+c;var l=k.insertRow(k.rows.length);var m=document.createElement("td");m.rowSpan=2;m.align="center";if(this.IE){var n=document.createElement("span");n.style.cssText="width:40px;height:40px;display:inline-block;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+g+" ')";m.appendChild(n)}else{m.innerHTML="<img src='"+g+"'/>"}m.style.width="60px";l.appendChild(m);m=document.createElement("td");m.align="left";m.vAlign="bottom";m.style.cssText="width:300px;height:30px";m.innerHTML="<div class='fileName'><div class='fileName'>"+f+"</div></div> ";m.className="fileName";l.appendChild(m);m=document.createElement("td");m.style.cssText="width:140px;height:30px";m.innerHTML="<div title='"+this.strings.remove+"' id='dhxvlt_icoremove'></div><a href='javascript:void(0)' class='link dhxvlt_txtremove'>"+this.strings.remove+"</a>";m.firstChild.onclick=m.childNodes[1].onclick=function(){e.removeItem(c)};m.vAlign="bottom";m.align="center";l.appendChild(m);l=k.insertRow(k.rows.length);m=document.createElement("td");m.align="left";m.style.cssText="width:300px;height:30px";l.appendChild(m);m=document.createElement("td");m.style.cssText="width:140px;height:30px";m.innerHTML="<a href='javascript:void(0)' class='link' style='visibility:hidden'>"+this.strings.upload+"</a>";m.firstChild.onclick=function(){e.uploadFile(c);return false};m.vAlign="middle";m.align="center";l.appendChild(m);this.checkFilesLimit()};dhtmlXVaultObject.prototype.getFileExtension=function(a){var b="",c=a.split(".");if(c.length>1)b=c[c.length-1].toLowerCase();return b};dhtmlXVaultObject.prototype.getImgFile=function(a){var b=this.imPath+"ico_image.png";var c=this.imPath+"ico_video.png";var d=this.imPath+"ico_sound.png";var e=this.imPath+"ico_zip.png";var f=this.imPath+"ico_file.png";var g="jpg,jpeg,gif,png,bmp,tiff";var h="avi,mpg,mpeg,rm,move";var i="wav,mp3,ogg";var j="zip,rar,tar,tgz,arj";var k=this.getFileExtension(a);if(k=="")return f;if(g.indexOf(k)!=-1){return b}if(h.indexOf(k)!=-1){return c}if(i.indexOf(k)!=-1){return d}if(j.indexOf(k)!=-1){return e}return f};dhtmlXVaultObject.prototype.createId=function(){return this.counter++};dhtmlXVaultObject.prototype.createTblListFiles=function(){var a=document.createElement("table");a.id="tblListFiles";a.style.backgroundColor="#FFFFFF";a.cellPadding="0";a.cellSpacing="0";a.border="0";return a};dhtmlXVaultObject.prototype.removeItem=function(a){var b=this.getCurrentRowListFiles(a);b.parentNode.removeChild(b);delete this.fileList[a];this.checkFilesLimit()};dhtmlXVaultObject.prototype.removeAllItems=function(){if(!this.isUploadFile){if(this.tblListFiles!=null){var a=this.tblListFiles.rows.length;if(a>0){for(var b=0;b<a;b++){this.tblListFiles.deleteRow(0)}}}this.fileList={}}this.checkFilesLimit()};dhtmlXVaultObject.prototype.uploadAllItems=function(){var a=-1;if(this.tblListFiles!=null){if(this.tblListFiles.rows.length>0){for(var b=0;b<this.tblListFiles.rows.length;b++){if(this.tblListFiles.rows[b].attributes["isUpload"].value=="false"){a=b;break}}if(a!=-1){this.isUploadFileAll=true;var c=this.tblListFiles.rows[b].attributes["fileItemId"].value;this.uploadFile(c)}else{if(this.isUploadFileAll)try{this.onUploadComplete(this.objToArray(this.fileList))}catch(d){}this.fileList={};this.isUploadFileAll=false}}}};dhtmlXVaultObject.prototype.objToArray=function(a){var b=new Array;for(var c in a){b[b.length]=a[c]}return b};dhtmlXVaultObject.prototype.createProgressDemo=function(){var a=this.imPath+"pb_demoupload.gif";var b=document.createElement("table");b.cellPadding="0";b.cellSpacing="0";b.border="0";b.style.cssText="height:10px;width:153px;display:none;";b.id="progress";var c=b.insertRow(b.rows.length);var d=document.createElement("td");d.style.cssText="font-size:1px;border:1px solid #A9AEB3;";d.innerHTML="<img src="+a+" style = 'width:150px;height:8px;'/>";c.appendChild(d);return b};dhtmlXVaultObject.prototype.createProgressBar=function(){var a=this.imPath+"pb_back.gif";var b=this.imPath+"pb_empty.gif";var c=document.createElement("table");c.cellPadding="0";c.cellSpacing="0";c.border="0";c.style.cssText="height:10px;width:149px;border-bottom:0px !important;display:none";c.id="progress";var d=c.insertRow(c.rows.length);var e=document.createElement("td");e.style.cssText="font-size:1px;background-image:url("+a+");width:150px;height:10px;border:1px solid #A9AEB3";e.align="right";var f=document.createElement("img");f.src=b;f.style.width="100%";f.style.height="7px";e.appendChild(f);d.appendChild(e);return c};dhtmlXVaultObject.prototype.createPercentPanel=function(){var a=document.createElement("div");a.style.cssText="font-size:9px;height:8px;position:absolute;left:210px;width:20px;display:none;padding-top:0px";a.id="percentCompletedValue";return a};dhtmlXVaultObject.prototype.endLoading=function(a,b){this.isUploadFile=false;this.progressDemo.style.display="none";this.container.appendChild(this.progressDemo);var c=this.fileList[a];if(c){c.error=b;c.uploaded=!b}try{this.onFileUploaded(c)}catch(d){}if(b)try{this.onUploadComplete(this.objToArray(this.fileList))}catch(d){}var e=this.getCurrentInputFile(a);if(e)e.parentNode.removeChild(e)};dhtmlXVaultObject.prototype.startRequest=function(a){var b=this.createXMLHttpRequest();b.open("POST",this.pathGetIdHandler,false);b.send("id="+a);if(b.status==200){if(!b.responseText){throw"error"}this.sessionId=b.responseText;this.inpUPLOAD_IDENTIFIER.value=this.sessionId}else{throw"error"}};dhtmlXVaultObject.prototype.sendIdSession=function(a){try{var b=this.createXMLHttpRequest();b.open("post",this.pathGetInfoHandler,false);b.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");b.send("sessionId="+this.sessionId);if(b.status==200){var c=b.responseText;if(c){var d=c.split(":");if(d[0]=="error"){if(d[1]==-2){var e=document.getElementById("dhtmlxVaultUploadFrame");if(e)e.src="about:blank";alert(this.printf(this.strings.errors["TooBig"],d[2],d[3]))}else if(d[1]==-3){alert(this.printf(this.strings.errors["PostSize"],d[2]))}throw"error"}c=parseInt(c,10);if(isNaN(c)){throw"error"}if(c!=-1){var f=this;try{window.setTimeout(function(){f.sendIdSession(a)},500)}catch(g){}}else if(c==-1){this.uploadedCount++;this.endLoading(a,false);this.showMessageInfo(a,this.strings.done);if(this.isUploadFileAll){this.uploadAllItems()}}}}else{throw"error"}}catch(g){this.endLoading(a,true);this.isUploadFileAll=false;this.isUploadFile=false;this.showMessageInfo(a,this.strings.error)}};dhtmlXVaultObject.prototype.printf=function(){var a=arguments.length;var b=arguments[0];for(var c=1;c<a;c++){var d="\\{"+(c-1)+"\\}";var e=new RegExp(d,"g");b=b.replace(e,arguments[c])}return b};dhtmlXVaultObject.prototype.showMessageInfo=function(a,b){var c=this.getCurrentTblContent(a);c.rows[1].cells[0].innerHTML+="<font class='text'>"+b+"</font>";c.rows[1].cells[0].vAlign="top"};dhtmlXVaultObject.prototype.showProgressInfo=function(a){this.tblProgressBar.rows[0].cells[0].firstChild.style.width=100-a+"%";this.percentPanel.innerHTML="<nobr>"+a+"%</nobr>"};dhtmlXVaultObject.prototype.getFilesCount=function(){return this.tblListFiles&&this.tblListFiles.rows?this.tblListFiles.rows.length:0};dhtmlXVaultObject.prototype.getTotalFilesCount=function(){var a=this.uploadedCount;if(this.tblListFiles!=null){if(this.tblListFiles.rows.length>0){for(var b=0;b<this.tblListFiles.rows.length;b++){if(this.tblListFiles.rows[b].attributes["isUpload"].value=="false"){a++}}}}return a};dhtmlXVaultObject.prototype.getCurrentRowListFiles=function(a){for(var b=0;b<this.tblListFiles.rows.length;b++){if(this.tblListFiles.rows[b].id=="rowListFiles"+a){return this.tblListFiles.rows[b]}}};dhtmlXVaultObject.prototype.getCurrentTblContent=function(a){for(var b=0;b<this.tblListFiles.rows.length;b++){if(this.tblListFiles.rows[b].cells[0].firstChild.id=="tblContent"+a){return this.tblListFiles.rows[b].cells[0].firstChild}}};dhtmlXVaultObject.prototype.getFormField=function(a,b){var c=this.uploadForm.getElementsByTagName("input");for(var d=0;d<c.length;d++){var e=c[d];if(e.type.toLowerCase()==a&&e.name==b){return e}}return null};dhtmlXVaultObject.prototype.getCurrentInputFile=function(a){return this.getFormField("file","file"+a)};dhtmlXVaultObject.prototype.uploadFile=function(a){if(!this.isUploadFile){this.selectItem(a);var b=this.getCurrentTblContent(a);b.rows[0].cells[2].removeChild(b.rows[0].cells[2].firstChild);b.rows[1].cells[1].removeChild(b.rows[1].cells[1].firstChild);b.parentNode.parentNode.attributes["isUpload"].value="true";this.isUploadFile=true;this.getCurrentInputFile(a).disabled=false;this.progressDemo.style.display="inline";this.getCurrentRowListFiles(a).cells[0].firstChild.rows[1].cells[0].appendChild(this.progressDemo);try{this.startRequest(a);this.sendIdSession(a)}catch(c){this.endLoading(a,true);this.isUploadFileAll=false;this.isUploadFile=false;b.rows[1].cells[0].innerHTML+="<font class='text'>"+this.strings.error+"</font>";b.rows[1].cells[0].vAlign="top";return}if(!this.isUploadFile)return;this.uploadForm.action=this.pathUploadHandler+"?sessionId="+this.sessionId+"&fileName="+escape(this.getFileName(this.getCurrentInputFile(a).value))+"&userfile="+this.getCurrentInputFile(a).id;this.uploadForm.submit()}};dhtmlXVaultObject.prototype.preLoadImages=function(){var a=new Array("add.gif","add_d.gif","btn1.gif","btn2.gif","btn3.gif","clean.gif","upload.gif","delete.gif","ico_file.png","ico_image.png","ico_sound.png","ico_video.png","ico_zip.png","pb_back.gif","pb_demoupload.gif","pb_empty.gif","rowsel.gif");var b=new Array(a.length);for(var c=0;c<a.length;c++){b[c]=new Image;b[c].src=this.imPath+a[c]}};dhtmlXVaultObject.prototype.setFilesLimit=function(a){var b=parseInt(a);if(!isNaN(b)&&b>=0)this.filesLimit=b};dhtmlXVaultObject.prototype.setFormField=function(a,b){if(!this.uploadForm){alert("Please call setFormField() method after create()!");return}var c=this.getFormField("hidden",a);if(b===null){if(c)this.uploadForm.removeChild(c)}else{if(!c){c=document.createElement("input");c.type="hidden";c.name=a;this.uploadForm.appendChild(c)}c.value=b}};dhtmlXVaultObject.prototype.onAddFile=function(a){return true};dhtmlXVaultObject.prototype.onUploadComplete=function(a){};dhtmlXVaultObject.prototype.onFileUploaded=function(a){}
